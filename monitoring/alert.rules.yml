groups:
    - name: general-alerts
      rules:
          # ðŸ”´ Alerte si une instance ne rÃ©pond plus
          - alert: InstanceDown
            expr: up == 0
            for: 1m
            labels:
                severity: critical
            annotations:
                summary: "Instance {{ $labels.instance }} down"
                description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 1 minute."

    - name: node-health
      rules:
          # ðŸ”´ CPU trop Ã©levÃ© (> 90% pendant 5 min)
          - alert: HighCPUUsage
            expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
            for: 5m
            labels:
                severity: warning
            annotations:
                summary: "High CPU usage on {{ $labels.instance }}"
                description: "CPU usage is above 90% for the last 5 minutes."

          # ðŸ”´ RAM trop Ã©levÃ©e (> 90% pendant 5 min)
          - alert: HighMemoryUsage
            expr: (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 > 90
            for: 5m
            labels:
                severity: warning
            annotations:
                summary: "High Memory usage on {{ $labels.instance }}"
                description: "Memory usage is above 90% for the last 5 minutes."

          # ðŸ”´ Espace disque faible (< 10% disponible)
          - alert: LowDiskSpace
            expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) * 100 < 10
            for: 10m
            labels:
                severity: critical
            annotations:
                summary: "Low disk space on {{ $labels.instance }} ({{ $labels.device }})"
                description: "Disk space is below 10% for more than 10 minutes."

    - name: container-health
      rules:
          # ðŸ”´ Container arrÃªtÃ©
          - alert: ContainerDown
            expr: up{job="cadvisor"} == 0
            for: 1m
            labels:
                severity: critical
            annotations:
                summary: "cAdvisor is down"
                description: "cAdvisor monitoring is not responding."

          # ðŸ”´ Container consomme trop de CPU (> 80% pendant 5 min)
          - alert: ContainerHighCPU
            expr: (rate(container_cpu_usage_seconds_total{image!="",name!=""}[5m]) * 100) > 80
            for: 5m
            labels:
                severity: warning
            annotations:
                summary: "High CPU usage for container {{ $labels.name }}"
                description: "Container {{ $labels.name }} has used more than 80% CPU for the last 5 minutes ({{ $value | humanize }}%)."

          # ðŸ”´ Container consomme trop de mÃ©moire (> 80%)
          - alert: ContainerHighMemory
            expr: (container_memory_working_set_bytes{image!="",name!=""} / container_spec_memory_limit_bytes{image!="",name!=""}) * 100 > 80
            for: 5m
            labels:
                severity: warning
            annotations:
                summary: "High Memory usage for container {{ $labels.name }}"
                description: "Container {{ $labels.name }} is using {{ $value | humanize1024 }}% of its memory limit."

          # ðŸ”´ Container redÃ©marre souvent
          - alert: ContainerRestarting
            expr: rate(container_start_time_seconds{name!=""}[5m]) > 0.01
            for: 5m
            labels:
                severity: warning
            annotations:
                summary: "Container {{ $labels.name }} is restarting frequently"
                description: "Container {{ $labels.name }} has restarted {{ $value | humanize }} times per second over the last 5 minutes."